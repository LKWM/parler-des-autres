<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chapitre 2: Désigner des personnes et des objets - Leçon 4</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for Audio Synth -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans', 'Noto Sans KR', sans-serif;
            overflow: hidden;
            background-color: white;
            touch-action: manipulation;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
        }

        #game-container {
            position: relative;
            background: white;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            #game-container {
                border-radius: 0;
                margin: 0;
                box-shadow: none;
            }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sentence-part {
            display: inline-block;
            white-space: pre;
        }

        .btn-hover:active {
            transform: scale(0.95);
        }

        .korean-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
    </style>
</head>
<body class="bg-white">

    <div id="game-container">
        <!-- Progress Bar -->
        <div class="absolute top-0 left-0 w-full h-1.5 bg-gray-100 z-50">
            <div id="progress-bar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
        </div>

        <!-- Main Content Area -->
        <div id="content-area" class="flex-1 w-full relative overflow-hidden flex flex-col items-center justify-center p-4">
            <!-- Dynamic Content -->
        </div>

        <!-- Navigation Bar -->
        <div id="nav-area" class="w-full h-20 px-6 md:px-12 flex justify-between items-center bg-white border-t border-gray-100 z-40 shrink-0">
            <button type="button" id="prev-btn" class="btn-hover bg-gray-100 text-gray-600 w-12 h-12 rounded-full flex items-center justify-center hover:bg-gray-200 transition-all disabled:opacity-30 disabled:cursor-not-allowed">
                <i class="ph ph-arrow-left text-xl font-bold"></i>
            </button>
            
            <button type="button" id="next-btn" class="btn-hover bg-indigo-600 text-white px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-indigo-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                Continuer <i class="ph ph-arrow-right font-bold"></i>
            </button>
        </div>
    </div>

    <script>
        const BASE_44_ORIGIN = "https://coreeno.base44.app"; 
        const CLOVA_API_FUNCTION_URL = BASE_44_ORIGIN + '/api/functions/naverClovaSpeech';

        // --- Data & State Management ---
        const exerciseStates = {}; 

        const lessonData = [
            {
                type: 'cover',
                chapter: 'Chapitre 2: Désigner des personnes et des objets',
                title: 'Leçon 4: Comment désigner des personnes et des objets',
                btnText: 'Commencer'
            },
            {
                type: 'intro',
                text: "Bonjour ! Bienvenue dans le Chapitre 2. Dans ce chapitre, nous allons nous entraîner à désigner des personnes ou des objets proches, comme avec 'Ceci' en français.",
                audio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769933874/audio_1_i1vm6p.mp3"
            },
            {
                type: 'learn',
                korean: "이 사람",
                subtitle1: `<span class="text-red-500">Cette</span> <span class="text-blue-600">personne</span>`,
                subtitle2: "Cette personne",
                parts: [
                    { text: "이", meaning: "Cette", color: "text-red-500" },
                    { text: " ", meaning: " ", color: "" },
                    { text: "사람", meaning: "personne", color: "text-blue-600" }
                ],
                explanation: "Pour désigner une personne ou un objet proche, on utilise le démonstratif '이'. Comme dans '이 사람' (cette personne), '이' se place devant le nom et il faut laisser un espace entre le démonstratif et le nom.",
                mainAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769932417/%E1%84%8B%E1%85%B5_%E1%84%89%E1%85%A1%E1%84%85%E1%85%A1%E1%86%B7_zlkkem.mp3",
                explAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769933992/audio_2_o0w6do.mp3"
            },
            {
                type: 'learn',
                korean: "이 사람은 동현 씨예요.",
                subtitle1: `<span class="text-red-500">Cette</span> <span class="text-blue-600">personne</span> <span class="text-orange-500">Donghyun</span> <span class="text-green-600">être</span>.`,
                subtitle2: "Il est Donghyun.", 
                parts: [
                    { text: "이", meaning: "Cette", color: "text-red-500" },
                    { text: " ", meaning: " ", color: "" },
                    { text: "사람", meaning: "personne", color: "text-blue-600" },
                    { text: "은", meaning: "", color: "text-gray-400" },
                    { text: " ", meaning: " ", color: "" },
                    { text: "동현", meaning: "Donghyun", color: "text-orange-500" },
                    { text: " ", meaning: " ", color: "" },
                    { text: "씨", meaning: "", color: "text-gray-400" },
                    { text: "예요.", meaning: "être", color: "text-green-600" }
                ],
                explanation: "En coréen, au lieu des pronoms personnels comme 'il' ou 'elle', on utilise souvent le démonstratif avec 'personne' (사람) pour désigner quelqu'un. Il n'y a pas de distinction de genre (masculin/féminin).",
                mainAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769932417/L4S1_ipxart.mp3",
                explAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769933993/audio_3_exdhmb.mp3"
            },
            {
                type: 'repeat',
                korean: "이 사람은 동현 씨예요.",
                subtitle1: "Cette personne Donghyun être",
                subtitle2: "Il est Donghyun.",
                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769932417/L4S1_ipxart.mp3"
            },
            {
                type: 'learn',
                korean: "이 건물은 학교예요.",
                subtitle1: `<span class="text-red-500">Ce</span> <span class="text-blue-600">bâtiment</span> <span class="text-orange-500">école</span> <span class="text-green-600">être</span>.`,
                subtitle2: "C’est une école.",
                parts: [
                    { text: "이", meaning: "Ce", color: "text-red-500" },
                    { text: " ", meaning: " ", color: "" },
                    { text: "건물", meaning: "bâtiment", color: "text-blue-600" },
                    { text: "은", meaning: "", color: "text-gray-400" },
                    { text: " ", meaning: " ", color: "" },
                    { text: "학교", meaning: "école", color: "text-orange-500" },
                    { text: "예요.", meaning: "être", color: "text-green-600" }
                ],
                explanation: "On utilise aussi '이' pour désigner des objets proches comme un bâtiment. '이' est un déterminant, il ne peut jamais être utilisé seul. Il doit toujours être accompagné d'un nom, comme '건물' (bâtiment).",
                mainAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769932417/L4S2_o7oh2z.mp3",
                explAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769934120/audio_4_grxyld.mp3"
            },
            {
                type: 'repeat',
                korean: "이 건물은 학교예요.",
                subtitle1: "Ce bâtiment école être",
                subtitle2: "C’est une école.",
                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769932417/L4S2_o7oh2z.mp3"
            },
            {
                type: 'learn',
                korean: "이것은 책이에요.",
                subtitle1: `<span class="text-red-500">Ceci</span> <span class="text-blue-600">livre</span> <span class="text-green-600">être</span>.`,
                subtitle2: "C’est un livre.",
                parts: [
                    { text: "이것", meaning: "Ceci", color: "text-red-500" },
                    { text: "은", meaning: "", color: "text-gray-400" },
                    { text: " ", meaning: " ", color: "" },
                    { text: "책", meaning: "livre", color: "text-blue-600" },
                    { text: "이에요.", meaning: "être", color: "text-green-600" }
                ],
                explanation: "Comme '이' ne peut pas être utilisé seul, si on ne connaît pas le nom de l'objet ou qu'on ne le précise pas, on utilise '이것' (ceci/cette chose).",
                mainAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769932417/L4S3_djn3r7.mp3",
                explAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769934274/audio_5_cngynr.mp3"
            },
            {
                type: 'repeat',
                korean: "이것은 책이에요.",
                subtitle1: "Ceci livre être",
                subtitle2: "C’est un livre.",
                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769932417/L4S3_djn3r7.mp3"
            },
            {
                type: 'repeat',
                korean: "이 사람은 동현 씨예요.",
                subtitle1: "Cette personne Donghyun être",
                subtitle2: "Il est Donghyun.",
                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769932417/L4S1_ipxart.mp3"
            },
            {
                type: 'repeat',
                korean: "이 건물은 학교예요.",
                subtitle1: "Ce bâtiment école être",
                subtitle2: "C’est une école.",
                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769932417/L4S2_o7oh2z.mp3"
            },
            {
                type: 'repeat',
                korean: "이것은 책이에요.",
                subtitle1: "Ceci livre être",
                subtitle2: "C’est un livre.",
                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769932417/L4S3_djn3r7.mp3"
            },
            {
                type: 'quiz',
                question: "Quelle particule ajoute-t-on lorsque le nom marquant le sujet de la phrase se termine par une consonne ?",
                options: ["는", "은", "이", "요"],
                answer: 1 
            },
            {
                type: 'quiz',
                question: "Comment se conjugue <이다> lorsque le complément se termine par une voyelle ?",
                options: ["이요", "예요", "이에요", "이야", "는"],
                answer: 1 
            },
            {
                type: 'quiz',
                question: "Quelle particule ajoute-t-on lorsque le nom marquant le sujet de la phrase se termine par une voyelle ?",
                options: ["이", "를", "는", "은", "다"],
                answer: 2 
            },
            {
                type: 'quiz',
                question: "Comment se conjugue <이다> lorsque le complément se termine par une consonne ?",
                options: ["이오", "였어요", "이에요", "있어요"],
                answer: 2 
            },
            {
                type: 'quiz',
                question: "Quel démonstratif place-t-on devant un nom pour désigner une personne ou un objet proche ?",
                options: ["이", "다", "그", "는", "저"],
                answer: 0 // 이
            },
            {
                type: 'quiz',
                question: "Choisissez l'affirmation correcte concernant le pronom '이' (Ceci).",
                options: ["Le pronom '이' peut être utilisé seul.", "Le pronom '이' ne peut pas être utilisé seul."],
                answer: 1 // Cannot be used alone
            },
            {
                type: 'outro',
                text: "Bon travail ! Dans la leçon 5 et 6, entraînez-vous avec des mots et des expressions pour désigner des personnes et des objets !",
                audio: "https://res.cloudinary.com/de76i94ia/video/upload/v1769934348/audio_6_aimgpr.mp3"
            }
        ];

        // --- State ---
        let currentIndex = 0;
        let audioPlayer = new Audio();
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let correctSound = null;
        let completionSynth = null;
        let pageTurnSynth = null;
        let hasInteracted = false;
        const visitedPages = new Set();
        let autoPlayTimeout = null;
        let recordingTimeout = null; 

        // --- Tone.js ---
        async function initAudio() {
            if (hasInteracted) return;
            await Tone.start();
            correctSound = new Tone.Synth().toDestination();
            completionSynth = new Tone.PolySynth().toDestination();
            pageTurnSynth = new Tone.MembraneSynth({ envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
            hasInteracted = true;
        }

        function playPageSound() {
            if (pageTurnSynth && hasInteracted) pageTurnSynth.triggerAttackRelease("C2", "32n");
        }

        // --- DOM ---
        const contentArea = document.getElementById('content-area');
        const progressBar = document.getElementById('progress-bar');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const navArea = document.getElementById('nav-area');

        // --- Core Functions ---
        function updateProgress() {
            const progress = ((currentIndex) / (lessonData.length - 1)) * 100;
            progressBar.style.width = `${progress}%`;
            
            if (currentIndex === 0) prevBtn.classList.add('invisible');
            else {
                prevBtn.classList.remove('invisible');
                prevBtn.disabled = false;
            }
            
            const currentData = lessonData[currentIndex];
            const state = getExerciseState(currentIndex);

            let canProceed = true;
            if (['quiz', 'listening_quiz'].includes(currentData.type)) {
                canProceed = state.passed; 
            } else if (currentData.type === 'speaking_challenge' || currentData.type === 'writing_challenge') {
                if (state.passed || state.attempts >= 3) canProceed = true;
                else canProceed = false;
            } else if (currentData.type === 'repeat') {
                 if (state.passed || state.attempts >= 3) canProceed = true;
                 else canProceed = false;
            }

            nextBtn.disabled = !canProceed;

            if (currentIndex === lessonData.length - 1) {
                nextBtn.innerHTML = `Terminer <i class="ph ph-check text-xl"></i>`;
            } else {
                nextBtn.innerHTML = `Continuer <i class="ph ph-arrow-right font-bold"></i>`;
                navArea.classList.remove('hidden');
            }
        }

        function stopAudio() {
            if(audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }
            if(autoPlayTimeout) clearTimeout(autoPlayTimeout);
        }

        function playAudio(url, onEndCallback, delay = 0) {
            stopAudio();
            if (!url) return;
            autoPlayTimeout = setTimeout(() => {
                audioPlayer.src = url;
                audioPlayer.play().catch(e => console.log("Audio blocked:", e));
                audioPlayer.onended = () => { if (onEndCallback) onEndCallback(); };
            }, delay);
        }

        function playAutoAudioIfNeeded(url) {
            if (!visitedPages.has(currentIndex)) {
                visitedPages.add(currentIndex);
                playAudio(url, null, 1000); 
            }
        }

        function getExerciseState(index) {
            if (!exerciseStates[index]) exerciseStates[index] = { attempts: 0, passed: false, hintLevel: 0, lastScore: 0, lastText: "" };
            return exerciseStates[index];
        }

        // --- Render Functions ---

        function renderCover(data) {
            contentArea.innerHTML = `
                <div class="fade-in w-full h-full flex flex-col items-center justify-center gap-10 text-center max-w-3xl mx-auto">
                    <div class="bg-indigo-100 p-8 rounded-full shadow-md shrink-0">
                        <i class="ph ph-book-open text-6xl text-indigo-600"></i>
                    </div>
                    <div class="space-y-6 shrink-0">
                        <h1 class="text-lg font-bold text-indigo-600 uppercase tracking-widest">${data.chapter}</h1>
                        <h2 class="text-2xl font-bold text-gray-800 leading-tight">${data.title}</h2>
                    </div>
                </div>
            `;
            visitedPages.add(currentIndex);
        }

        function renderIntro(data) {
            contentArea.innerHTML = `
                <div class="fade-in w-full h-full flex flex-col items-center justify-center max-w-3xl mx-auto">
                     <div class="w-full bg-white border border-gray-100 rounded-2xl shadow-sm p-6 md:p-10 text-lg md:text-2xl text-gray-700 leading-relaxed text-center">
                        ${data.text}
                     </div>
                </div>
            `;
            playAutoAudioIfNeeded(data.audio);
        }

        function renderLearn(data) {
            let sentenceHtml = data.parts.map(part => `<span class="${part.color} sentence-part text-2xl md:text-4xl font-bold">${part.text === " " ? "&nbsp;" : part.text}</span>`).join('');
            
            contentArea.innerHTML = `
                <div class="fade-in w-full h-full flex flex-col items-center justify-center gap-6 py-2 max-w-5xl mx-auto">
                    <div class="bg-white rounded-2xl shadow-lg w-full max-w-2xl border border-indigo-50 relative flex flex-col items-center justify-center p-6 md:p-8 shrink-0">
                        <div class="text-center mb-4 z-10">
                            <div class="flex flex-wrap justify-center items-end leading-snug">
                                ${sentenceHtml}
                            </div>
                        </div>
                        <button type="button" id="main-play-btn" class="relative z-20 w-16 h-16 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 hover:scale-105 transition-all shadow-md flex items-center justify-center mb-4 shrink-0">
                             <i class="ph ph-speaker-high text-3xl"></i>
                        </button>
                        <div class="space-y-1 text-center z-10">
                            <p class="text-base md:text-lg italic font-serif text-gray-600 bg-gray-50 px-4 py-1 rounded-lg inline-block">
                                ${data.subtitle1}
                            </p>
                            <p class="text-lg md:text-xl font-medium text-indigo-900 block">${data.subtitle2}</p>
                        </div>
                    </div>
                    <div class="w-full max-w-2xl bg-indigo-600 text-white p-4 rounded-xl shadow-md text-center text-sm md:text-base md:leading-loose leading-relaxed shrink-0">
                        ${data.explanation}
                    </div>
                </div>
            `;
            if (data.explAudio) playAutoAudioIfNeeded(data.explAudio);
            document.getElementById('main-play-btn').onclick = () => playAudio(data.mainAudio);
        }

        function renderRepeat(data) {
            const state = getExerciseState(currentIndex);
            
            contentArea.innerHTML = `
                <div class="fade-in w-full h-full flex flex-col items-center max-w-2xl mx-auto">
                    
                    <div class="flex-1 w-full flex flex-col justify-end items-center pb-4 min-h-0">
                        <h3 class="text-sm md:text-base font-bold text-indigo-600 uppercase tracking-wider text-center shrink-0">
                            Répétez après moi
                        </h3>
                    </div>
                    
                    <div class="bg-white w-full p-8 md:p-10 rounded-3xl shadow-xl border border-gray-100 relative flex flex-col items-center gap-6 shrink-0 z-10">
                        <div class="space-y-2 text-center">
                             <h2 class="text-3xl md:text-4xl font-bold text-gray-800 leading-snug">${data.korean}</h2>
                             <p class="text-base md:text-lg text-gray-500">${data.subtitle2}</p>
                        </div>
                        
                        <div class="flex justify-center gap-4 mt-2">
                            <button type="button" id="listen-btn" class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 flex items-center justify-center transition-all shadow-md">
                                <i class="ph ph-speaker-high text-3xl md:text-4xl"></i>
                            </button>
                            
                            <button type="button" id="record-btn" class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-red-100 text-red-500 hover:bg-red-200 flex items-center justify-center transition-all ring-4 ring-transparent shadow-md">
                                <i class="ph ph-microphone text-3xl md:text-4xl"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 w-full flex flex-col justify-start items-center pt-4 min-h-0">
                        <div id="feedback-area" class="h-16 flex items-center justify-center w-full text-center">
                            <p class="text-gray-400 text-sm">Appuyez sur le micro pour parler</p>
                        </div>
                    </div>
                </div>
            `;

            const listenBtn = document.getElementById('listen-btn');
            const recordBtn = document.getElementById('record-btn');
            const feedbackArea = document.getElementById('feedback-area');

            if (state.passed) {
                feedbackArea.innerHTML = `
                    <div class="bg-green-100 text-green-700 px-4 py-2 rounded-lg text-sm w-full">
                        <span class="font-bold block">Très bien ! Score: ${state.lastScore}</span>
                        ${state.lastText ? `<span class="text-xs font-normal opacity-80">"${state.lastText}"</span>` : ''}
                    </div>`;
                recordBtn.disabled = true;
                recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else if (state.attempts >= 3) {
                feedbackArea.innerHTML = `
                    <div class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm w-full">
                        <span class="font-bold block">Passons à la suite. Score: ${state.lastScore}</span>
                        ${state.lastText ? `<span class="text-xs font-normal opacity-80">"${state.lastText}"</span>` : ''}
                    </div>`;
                recordBtn.disabled = true;
                recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else if (state.attempts > 0) {
                feedbackArea.innerHTML = `
                    <div class="bg-orange-100 text-orange-700 px-4 py-2 rounded-lg text-sm w-full">
                        <span class="font-bold block">Essayez encore (${state.attempts}/3). Score: ${state.lastScore}</span>
                        ${state.lastText ? `<span class="text-xs font-normal opacity-80">"${state.lastText}"</span>` : ''}
                    </div>`;
            }

            listenBtn.onclick = () => {
                playAudio(data.refAudio);
            };

            recordBtn.onclick = async () => {
                if (state.attempts >= 3 || state.passed) return; 
                if (!isRecording) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                        
                        mediaRecorder.onstop = async () => {
                            stream.getTracks().forEach(track => track.stop());
                            if (recordingTimeout) clearTimeout(recordingTimeout);
                            
                            try {
                                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                                const reader = new FileReader();
                                reader.readAsDataURL(audioBlob);
                                reader.onloadend = async () => {
                                    const base64 = reader.result.split(',')[1];
                                    await processSpeech(base64, data.korean, currentIndex);
                                };
                            } catch (e) {
                                console.error("Error processing audio", e);
                            }
                        };
                        
                        mediaRecorder.start();
                        isRecording = true;
                        
                        recordingTimeout = setTimeout(() => {
                            if (isRecording && mediaRecorder.state === 'recording') {
                                mediaRecorder.stop();
                                isRecording = false;
                                if (document.contains(recordBtn)) {
                                    recordBtn.classList.remove('bg-red-500', 'text-white', 'ring-red-200');
                                    recordBtn.innerHTML = '<i class="ph ph-microphone text-3xl md:text-4xl"></i>';
                                    if(feedbackArea) feedbackArea.innerHTML = '<p class="text-gray-500 text-sm">Analyse...</p>';
                                }
                            }
                        }, 12000);

                        recordBtn.classList.add('bg-red-500', 'text-white', 'ring-red-200');
                        recordBtn.innerHTML = '<i class="ph ph-stop text-3xl md:text-4xl"></i>';
                        feedbackArea.innerHTML = '<p class="text-indigo-600 animate-pulse text-sm">Enregistrement...</p>';
                    } catch (err) {
                        console.error(err);
                        feedbackArea.innerHTML = '<p class="text-red-400 text-sm">Microphone requis.</p>';
                    }
                } else {
                    if (recordingTimeout) clearTimeout(recordingTimeout);
                    mediaRecorder.stop();
                    isRecording = false;
                    recordBtn.classList.remove('bg-red-500', 'text-white', 'ring-red-200');
                    recordBtn.innerHTML = '<i class="ph ph-microphone text-3xl md:text-4xl"></i>';
                    feedbackArea.innerHTML = '<p class="text-gray-500 text-sm">Analyse...</p>';
                }
            };
        }

        function renderQuiz(data) {
             const state = getExerciseState(currentIndex);

             contentArea.innerHTML = `
                <div class="fade-in w-full h-full relative flex flex-col justify-center items-center">
                    <div class="w-full max-w-2xl flex flex-col gap-4 md:gap-6"> 
                        <div class="w-full bg-indigo-600 text-white p-4 md:p-5 rounded-2xl shadow-lg text-center shrink-0">
                             <h3 class="text-xs opacity-80 uppercase tracking-wide mb-1">Quiz</h3>
                             <h2 class="text-lg md:text-xl font-medium leading-snug">${data.question}</h2>
                        </div>
                        
                        <div class="w-full grid grid-cols-1 gap-2 md:gap-3 shrink-0">
                            ${data.options.map((opt, idx) => {
                                let btnClass = "quiz-opt-btn w-full p-4 rounded-xl border-2 text-gray-700 font-bold transition-all text-left flex justify-between items-center group bg-white shadow-sm text-sm md:text-base";
                                let iconClass = "ph ph-circle text-gray-300 text-xl";
                                let isDisabled = "";

                                if (state.passed) {
                                    isDisabled = "disabled";
                                    if (idx === data.answer) {
                                        btnClass += " border-green-500 bg-green-50 text-green-700";
                                        iconClass = "ph ph-check-circle text-green-500 text-xl";
                                    } else {
                                        btnClass += " border-gray-200 opacity-50";
                                    }
                                } else {
                                    btnClass += " border-gray-200 hover:border-indigo-400 hover:bg-indigo-50";
                                    iconClass += " group-hover:text-indigo-400";
                                }

                                return `
                                <button onclick="handleQuizAnswer(${idx}, ${data.answer}, this)" class="${btnClass}" ${isDisabled}>
                                    <span>${opt}</span>
                                    <i class="${iconClass}"></i>
                                </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div id="quiz-feedback" class="absolute bottom-4 w-full text-center font-bold h-8 text-sm"></div>
                </div>
            `;
        }

        window.handleQuizAnswer = (selectedIdx, correctIdx, btnElement) => {
            const state = getExerciseState(currentIndex);

            if (selectedIdx === correctIdx) {
                // Correct
                state.passed = true;
                if(correctSound) correctSound.triggerAttackRelease('E5', '0.1s');
                
                // Visual update directly to avoid reload flicker
                btnElement.classList.remove('border-gray-200', 'hover:border-indigo-400', 'hover:bg-indigo-50');
                btnElement.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
                btnElement.querySelector('i').className = "ph ph-check-circle text-green-500 text-xl";
                
                // Disable all others
                document.querySelectorAll('.quiz-opt-btn').forEach(b => {
                    b.disabled = true;
                    if(b !== btnElement) b.classList.add('opacity-50');
                });

                updateProgress();
            } else {
                // Wrong
                btnElement.classList.remove('border-gray-200');
                btnElement.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
                btnElement.querySelector('i').className = "ph ph-x-circle text-red-500 text-xl";
                
                if(correctSound) correctSound.triggerAttackRelease('G2', '0.2s');
            }
        };

        async function processSpeech(audioBase64, referenceText, pageIndex) {
            const state = getExerciseState(pageIndex);
            state.attempts++;

            try {
                const payload = { 
                    audioBase64: audioBase64, 
                    languageCode: "Kor", 
                    referenceText: referenceText 
                };
                console.log("Sending Ref:", referenceText);

                const res = await fetch(CLOVA_API_FUNCTION_URL, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("API Error: " + res.status); 
                const result = await res.json();
                
                const recognizedText = result.text || ""; 
                
                const cleanRef = referenceText.replace(/[\s.,?!]/g, "");
                const cleanRec = recognizedText.replace(/[\s.,?!]/g, "");

                let matchScore = 0;
                if (cleanRef.length === 0 && cleanRec.length === 0) {
                    matchScore = 100;
                } else {
                    const matrix = [];
                    for (let i = 0; i <= cleanRec.length; i++) matrix[i] = [i];
                    for (let j = 0; j <= cleanRef.length; j++) matrix[0][j] = j;

                    for (let i = 1; i <= cleanRec.length; i++) {
                        for (let j = 1; j <= cleanRef.length; j++) {
                            if (cleanRec.charAt(i - 1) === cleanRef.charAt(j - 1)) {
                                matrix[i][j] = matrix[i - 1][j - 1];
                            } else {
                                matrix[i][j] = Math.min(
                                    matrix[i - 1][j - 1] + 1, 
                                    matrix[i][j - 1] + 1,     
                                    matrix[i - 1][j] + 1      
                                );
                            }
                        }
                    }
                    const distance = matrix[cleanRec.length][cleanRef.length];
                    const maxLength = Math.max(cleanRef.length, cleanRec.length);
                    matchScore = Math.round(((maxLength - distance) / maxLength) * 100);
                }

                state.lastScore = matchScore;
                state.lastText = recognizedText; 

                if (matchScore >= 80) {
                    if(correctSound) correctSound.triggerAttackRelease('C5', '0.2s');
                    state.passed = true;
                } else {
                     if(correctSound) correctSound.triggerAttackRelease('G2', '0.2s');
                }
            } catch (e) {
                console.error("Speech Eval Failed:", e);
                state.lastScore = 0; 
                state.lastText = "Erreur de connexion";
                if(correctSound) correctSound.triggerAttackRelease('G2', '0.2s');
            }
            
            render(); 
            updateProgress();
        }

        function renderOutro(data) {
             navArea.classList.add('hidden');
             contentArea.innerHTML = `
                <div class="fade-in w-full h-full flex flex-col items-center justify-center gap-6 text-center max-w-2xl mx-auto">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Terminé !</h2>
                    <div class="w-full bg-indigo-600 text-white p-6 rounded-2xl shadow-lg text-base md:text-lg leading-relaxed">
                        ${data.text}
                    </div>
                </div>
            `;
            
            if (data.audio) {
                playAutoAudioIfNeeded(data.audio);
            }

            if (completionSynth) setTimeout(() => completionSynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "4n"), 500);
            window.parent.postMessage({ type: 'lesson_complete' }, '*');
        }

        // --- Render Engine ---
        function render() {
            stopAudio();
            updateProgress();
            const data = lessonData[currentIndex];
            contentArea.innerHTML = ''; 

            switch(data.type) {
                case 'cover': renderCover(data); break;
                case 'intro': renderIntro(data); break;
                case 'learn': renderLearn(data); break;
                case 'repeat': renderRepeat(data); break;
                case 'quiz': renderQuiz(data); break;
                case 'outro': renderOutro(data); break;
                default: console.error("Unknown type");
            }
        }

        async function nextPage() {
            await initAudio(); 
            playPageSound();
            if (currentIndex < lessonData.length - 1) {
                currentIndex++;
                render();
            }
        }

        function prevPage() {
            playPageSound();
            if (currentIndex > 0) {
                currentIndex--;
                render();
            }
        }

        nextBtn.addEventListener('click', nextPage);
        prevBtn.addEventListener('click', prevPage);

        render();
    </script>
</body>
</html>
