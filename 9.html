<!DOCTYPE html>

<html lang="fr">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Chapitre 3: Poser des questions et y répondre en utilisant le possessif - Leçon 9</title>

    <!-- Tailwind CSS -->

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tone.js for Audio Synth -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <!-- Phosphor Icons -->

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    

    <style>

        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');



        body {

            font-family: 'Noto Sans', 'Noto Sans KR', sans-serif;

            overflow: hidden;

            background-color: white;

            touch-action: manipulation;

            height: 100vh;

            width: 100vw;

            margin: 0;

            padding: 0;

        }



        #game-container {

            position: relative;

            background: white;

            width: 100%;

            height: 100%;

            overflow: hidden;

            display: flex;

            flex-direction: column;

        }



        @media (min-width: 768px) {

            #game-container {

                border-radius: 0;

                margin: 0;

                box-shadow: none;

            }

        }



        .fade-in {

            animation: fadeIn 0.4s ease-out;

        }



        @keyframes fadeIn {

            from { opacity: 0; transform: translateY(10px); }

            to { opacity: 1; transform: translateY(0); }

        }



        .sentence-part {

            display: inline-block;

            white-space: pre;

        }



        .btn-hover:active {

            transform: scale(0.95);

        }



        .korean-input:focus {

            outline: none;

            border-color: #6366f1;

            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);

        }

    </style>

</head>

<body class="bg-white">



    <div id="game-container">

        <!-- Progress Bar -->

        <div class="absolute top-0 left-0 w-full h-1.5 bg-gray-100 z-50">

            <div id="progress-bar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>

        </div>



        <!-- Main Content Area -->

        <div id="content-area" class="flex-1 w-full relative overflow-hidden flex flex-col items-center justify-center p-4">

            <!-- Dynamic Content -->

        </div>



        <!-- Navigation Bar -->

        <div id="nav-area" class="w-full h-20 px-6 md:px-12 flex justify-between items-center bg-white border-t border-gray-100 z-40 shrink-0">

            <button type="button" id="prev-btn" class="btn-hover bg-gray-100 text-gray-600 w-12 h-12 rounded-full flex items-center justify-center hover:bg-gray-200 transition-all disabled:opacity-30 disabled:cursor-not-allowed">

                <i class="ph ph-arrow-left text-xl font-bold"></i>

            </button>

            

            <button type="button" id="next-btn" class="btn-hover bg-indigo-600 text-white px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-indigo-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">

                Continuer <i class="ph ph-arrow-right font-bold"></i>

            </button>

        </div>

    </div>



    <script>

        const BASE_44_ORIGIN = "https://coreeno.base44.app"; 

        const CLOVA_API_FUNCTION_URL = BASE_44_ORIGIN + '/api/functions/naverClovaSpeech';



        // --- Data & State Management ---

        const exerciseStates = {}; 



        const lessonData = [

            {

                type: 'cover',

                chapter: 'Chapitre 3: Poser des questions et y répondre en utilisant le possessif',

                title: 'Leçon 9: Pratique (6) Poser des questions et y répondre',

                btnText: 'Commencer'

            },

            {

                type: 'repeat',

                instruction: "Répétez après moi.",

                korean: "이게 뭐예요?",

                subtitle1: "Ceci quoi être",

                subtitle2: "Qu’est-ce que c’est?",

                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111218/L7S3_pzmvfc.mp3" // Reused from Lesson 7

            },

            {

                type: 'repeat',

                instruction: "Répétez après moi.",

                korean: "이것은 제 옷이에요.",

                subtitle1: "Ceci mon vêtement être",

                subtitle2: "C’est mon vêtement.",

                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111219/L7S4_jalwkj.mp3" // Reused from Lesson 7

            },

            {

                type: 'repeat',

                instruction: "Répétez après moi.",

                korean: "이것은 제 연필이에요.",

                subtitle1: "Ceci mon crayon être",

                subtitle2: "C’est mon crayon.",

                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111233/L9S1_acemga.mp3"

            },

            {

                type: 'repeat',

                instruction: "Répétez encore une fois.",

                korean: "이것은 제 연필이에요.",

                subtitle1: "Ceci mon crayon être",

                subtitle2: "C’est mon crayon.",

                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111233/L9S1_acemga.mp3"

            },

            {

                type: 'repeat',

                instruction: "Répétez après moi.",

                korean: "이것은 제 모자예요.",

                subtitle1: "Ceci mon chapeau être",

                subtitle2: "C’est mon chapeau.",

                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111236/L9S2_hc1a6h.mp3"

            },

            {

                type: 'repeat',

                instruction: "Répétez encore une fois.",

                korean: "이것은 제 모자예요.",

                subtitle1: "Ceci mon chapeau être",

                subtitle2: "C’est mon chapeau.",

                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111236/L9S2_hc1a6h.mp3"

            },

            {

                type: 'listening_quiz',

                question: "Choisissez la bonne traduction.",

                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111246/%E1%84%6E%E1%85%A9%E1%84%8C%E1%85%A1_bi5ajt.mp3",

                word: "모자",

                options: ["Crayon", "Chapeau", "Chaise", "Vêtement"],

                answer: 1 // Chapeau

            },

            {

                type: 'listening_quiz',

                question: "Choisissez la bonne traduction.",

                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111237/L9S3_iqxkgq.mp3",

                word: "이것은 제 책이에요",

                options: ["Je suis un livre", "Je suis à l’école", "C’est mon livre", "Ceci est un crayon"],

                answer: 2 // C’est mon livre

            },

            {

                type: 'speaking_challenge',

                promptFr: "C’est mon livre.",

                promptKr: "___ 제 책이에요.",

                target: "이것은 제 책이에요.",

                hintAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111237/L9S3_iqxkgq.mp3"

            },

            {

                type: 'repeat',

                instruction: "Répétez après moi.",

                korean: "이것은 제 가방이에요.",

                subtitle1: "Ceci mon sac être",

                subtitle2: "C’est mon sac.",

                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111239/L9S4_p7n5cs.mp3"

            },

            {

                type: 'repeat',

                instruction: "Répétez encore une fois.",

                korean: "이것은 제 가방이에요.",

                subtitle1: "Ceci mon sac être",

                subtitle2: "C’est mon sac.",

                refAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111239/L9S4_p7n5cs.mp3"

            },

            {

                type: 'listening_quiz',

                question: "Choisissez la bonne traduction.",

                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111240/%E1%84%80%E1%85%A1%E1%84%87%E1%85%A1%E1%86%BC_zv57lk.mp3",

                word: "가방",

                options: ["Maison", "Chapeau", "Sac", "Crayon"],

                answer: 2 // Sac

            },

            {

                type: 'speaking_challenge',

                promptFr: "C’est ma mère.",

                promptKr: "이 ___ 우리 ____.",

                target: "이 사람은 우리 엄마예요.",

                hintAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111222/L7S2_mhartd.mp3" // Reused from Lesson 7

            },

            {

                type: 'quiz',

                question: "Choisissez les mots qui complètent la phrase.",

                context: "__은 제 __이에요.",

                meaning: "C’est mon crayon.",

                options: ["이 사람, 연필", "이것, 연필", "이 사람, 선생님", "이것, 선생님"],

                answer: 1 // 이것, 연필

            },

            {

                type: 'speaking_challenge',

                promptFr: "C’est mon chapeau.",

                promptKr: "이것은 제 __예요.",

                target: "이것은 제 모자예요.",

                hintAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111236/L9S2_hc1a6h.mp3"

            },

            {

                type: 'writing_challenge',

                promptFr: "C’est mon crayon.",

                target: "이것은 제 연필이에요.",

                hintAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111233/L9S1_acemga.mp3"

            },

            {

                type: 'writing_challenge',

                promptFr: "C’est mon étudiant.",

                target: "이 사람은 제 학생이에요.",

                hintAudio: "https://res.cloudinary.com/de76i94ia/video/upload/v1770111225/L8S3_ynjjls.mp3" // Reused from Lesson 8

            },

            {

                type: 'outro',

                text: "Bon travail ! Allez à la leçon supplémentaire et essayez de parler en coréen !", // Translated

                audio: null

            }

        ];



        // --- State ---

        let currentIndex = 0;

        let audioPlayer = new Audio();

        let isRecording = false;

        let mediaRecorder;

        let audioChunks = [];

        let correctSound = null;

        let completionSynth = null;

        let pageTurnSynth = null;

        let hasInteracted = false;

        const visitedPages = new Set();

        let autoPlayTimeout = null;

        let recordingTimeout = null; 



        // --- Tone.js ---

        async function initAudio() {

            if (hasInteracted) return;

            await Tone.start();

            correctSound = new Tone.Synth().toDestination();

            completionSynth = new Tone.PolySynth().toDestination();

            pageTurnSynth = new Tone.MembraneSynth({ envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();

            hasInteracted = true;

        }



        function playPageSound() {

            if (pageTurnSynth && hasInteracted) pageTurnSynth.triggerAttackRelease("C2", "32n");

        }



        // --- DOM ---

        const contentArea = document.getElementById('content-area');

        const progressBar = document.getElementById('progress-bar');

        const nextBtn = document.getElementById('next-btn');

        const prevBtn = document.getElementById('prev-btn');

        const navArea = document.getElementById('nav-area');



        // --- Core Functions ---

        function updateProgress() {

            const progress = ((currentIndex) / (lessonData.length - 1)) * 100;

            progressBar.style.width = `${progress}%`;

            

            if (currentIndex === 0) prevBtn.classList.add('invisible');

            else {

                prevBtn.classList.remove('invisible');

                prevBtn.disabled = false;

            }

            

            const currentData = lessonData[currentIndex];

            const state = getExerciseState(currentIndex);



            let canProceed = true;

            if (['quiz', 'listening_quiz'].includes(currentData.type)) {

                canProceed = state.passed; 

            } else if (currentData.type === 'speaking_challenge' || currentData.type === 'writing_challenge') {

                if (state.passed || state.attempts >= 3) canProceed = true;

                else canProceed = false;

            } else if (currentData.type === 'repeat') {

                 if (state.passed || state.attempts >= 3) canProceed = true;

                 else canProceed = false;

            }



            nextBtn.disabled = !canProceed;



            if (currentIndex === lessonData.length - 1) {

                nextBtn.innerHTML = `Terminer <i class="ph ph-check text-xl"></i>`;

            } else {

                nextBtn.innerHTML = `Continuer <i class="ph ph-arrow-right font-bold"></i>`;

                navArea.classList.remove('hidden');

            }

        }



        function stopAudio() {

            if(audioPlayer) {

                audioPlayer.pause();

                audioPlayer.currentTime = 0;

            }

            if(autoPlayTimeout) clearTimeout(autoPlayTimeout);

        }



        function playAudio(url, onEndCallback, delay = 0) {

            stopAudio();

            if (!url) return;

            autoPlayTimeout = setTimeout(() => {

                audioPlayer.src = url;

                audioPlayer.play().catch(e => console.log("Audio blocked:", e));

                audioPlayer.onended = () => { if (onEndCallback) onEndCallback(); };

            }, delay);

        }



        function playAutoAudioIfNeeded(url) {

            if (!visitedPages.has(currentIndex)) {

                visitedPages.add(currentIndex);

                playAudio(url, null, 1000); 

            }

        }



        function getExerciseState(index) {

            if (!exerciseStates[index]) exerciseStates[index] = { attempts: 0, passed: false, hintLevel: 0, lastScore: 0, lastText: "" };

            return exerciseStates[index];

        }



        // --- Render Functions ---



        function renderCover(data) {

            contentArea.innerHTML = `

                <div class="fade-in w-full h-full flex flex-col items-center justify-center gap-10 text-center max-w-3xl mx-auto">

                    <div class="bg-indigo-100 p-8 rounded-full shadow-md shrink-0">

                        <i class="ph ph-book-open text-6xl text-indigo-600"></i>

                    </div>

                    <div class="space-y-6 shrink-0">

                        <h1 class="text-lg font-bold text-indigo-600 uppercase tracking-widest">${data.chapter}</h1>

                        <h2 class="text-2xl font-bold text-gray-800 leading-tight">${data.title}</h2>

                    </div>

                </div>

            `;

            visitedPages.add(currentIndex);

        }



        function renderLearn(data) {

            let sentenceHtml = data.parts ? data.parts.map(part => `<span class="${part.color} sentence-part text-2xl md:text-4xl font-bold">${part.text === " " ? "&nbsp;" : part.text}</span>`).join('') : "";

            

            contentArea.innerHTML = `

                <div class="fade-in w-full h-full flex flex-col items-center justify-center gap-6 py-2 max-w-5xl mx-auto">

                    <div class="bg-white rounded-2xl shadow-lg w-full max-w-2xl border border-indigo-50 relative flex flex-col items-center justify-center p-6 md:p-8 shrink-0">

                        <div class="text-center mb-4 z-10">

                            <div class="flex flex-wrap justify-center items-end leading-snug">

                                ${sentenceHtml}

                            </div>

                        </div>

                        <button type="button" id="main-play-btn" class="relative z-20 w-16 h-16 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 hover:scale-105 transition-all shadow-md flex items-center justify-center mb-4 shrink-0">

                             <i class="ph ph-speaker-high text-3xl"></i>

                        </button>

                        <div class="space-y-1 text-center z-10">

                            <p class="text-base md:text-lg italic font-serif text-gray-600 bg-gray-50 px-4 py-1 rounded-lg inline-block">

                                ${data.subtitle1}

                            </p>

                            <p class="text-lg md:text-xl font-medium text-indigo-900 block">${data.subtitle2}</p>

                        </div>

                    </div>

                    <div class="w-full max-w-2xl bg-indigo-600 text-white p-4 rounded-xl shadow-md text-center text-sm md:text-base md:leading-loose leading-relaxed shrink-0">

                        ${data.explanation}

                    </div>

                </div>

            `;

            if (data.explAudio) playAutoAudioIfNeeded(data.explAudio);

            document.getElementById('main-play-btn').onclick = () => playAudio(data.mainAudio);

        }



        function renderRepeat(data) {

            renderCommonSpeaking(data, "repeat");

        }



        function renderSpeakingChallenge(data) {

            renderCommonSpeaking(data, "challenge");

        }



        function renderCommonSpeaking(data, mode) {

            const state = getExerciseState(currentIndex);

            

            let displayKorean = "";

            let showAudioBtn = false;



            if (mode === "repeat") {

                displayKorean = data.korean;

                showAudioBtn = true;

            } else {

                if (state.passed || state.attempts >= 2) {

                    displayKorean = data.target; 

                } else {

                    displayKorean = data.promptKr || "___"; 

                }

                if (state.attempts >= 1 || state.passed) {

                    showAudioBtn = true;

                }

            }



            const instructionText = data.instruction || (mode === 'repeat' ? 'Répétez après moi' : 'Parlez en coréen');



            contentArea.innerHTML = `

                <div class="fade-in w-full h-full flex flex-col items-center max-w-2xl mx-auto">

                    <div class="flex-1 w-full flex flex-col justify-end items-center pb-4 min-h-0">

                        <h3 class="text-sm md:text-base font-bold text-indigo-600 uppercase tracking-wider text-center shrink-0">

                            ${instructionText}

                        </h3>

                    </div>

                    

                    <div class="bg-white w-full p-8 md:p-10 rounded-3xl shadow-xl border border-gray-100 relative flex flex-col items-center gap-6 shrink-0 z-10">

                        <div class="space-y-2 text-center">

                             ${mode === 'challenge' ? `<p class="text-gray-500 text-lg mb-2">${data.promptFr}</p>` : ''}

                             <h2 class="text-3xl md:text-4xl font-bold text-gray-800 leading-snug">${displayKorean}</h2>

                             ${mode === 'repeat' ? `<p class="text-base md:text-lg text-gray-500">${data.subtitle2}</p>` : ''}

                        </div>

                        

                        <div class="flex justify-center gap-4 mt-2">

                            <button type="button" id="listen-btn" class="${showAudioBtn ? '' : 'hidden'} w-16 h-16 md:w-20 md:h-20 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 flex items-center justify-center transition-all shadow-md">

                                <i class="ph ph-speaker-high text-3xl md:text-4xl"></i>

                            </button>

                            

                            <button type="button" id="record-btn" class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-red-100 text-red-500 hover:bg-red-200 flex items-center justify-center transition-all ring-4 ring-transparent shadow-md">

                                <i class="ph ph-microphone text-3xl md:text-4xl"></i>

                            </button>

                        </div>

                    </div>



                    <div class="flex-1 w-full flex flex-col justify-start items-center pt-4 min-h-0">

                        <div id="feedback-area" class="h-16 flex items-center justify-center w-full text-center">

                            <p class="text-gray-400 text-sm">Appuyez sur le micro pour parler</p>

                        </div>

                    </div>

                </div>

            `;



            const listenBtn = document.getElementById('listen-btn');

            const recordBtn = document.getElementById('record-btn');

            const feedbackArea = document.getElementById('feedback-area');



            if (state.passed) {

                feedbackArea.innerHTML = `

                    <div class="bg-green-100 text-green-700 px-4 py-2 rounded-lg text-sm w-full">

                        <span class="font-bold block">Très bien ! Score: ${state.lastScore}</span>

                        ${state.lastText ? `<span class="text-xs font-normal opacity-80">"${state.lastText}"</span>` : ''}

                    </div>`;

                recordBtn.disabled = true;

                recordBtn.classList.add('opacity-50', 'cursor-not-allowed');

            } else if (state.attempts >= 3) {

                feedbackArea.innerHTML = `

                    <div class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm w-full">

                        <span class="font-bold block">Passons à la suite. Score: ${state.lastScore}</span>

                        ${state.lastText ? `<span class="text-xs font-normal opacity-80">"${state.lastText}"</span>` : ''}

                    </div>`;

                recordBtn.disabled = true;

                recordBtn.classList.add('opacity-50', 'cursor-not-allowed');

            } else if (state.attempts > 0) {

                feedbackArea.innerHTML = `

                    <div class="bg-orange-100 text-orange-700 px-4 py-2 rounded-lg text-sm w-full">

                        <span class="font-bold block">Essayez encore (${state.attempts}/3). Score: ${state.lastScore}</span>

                        ${state.lastText ? `<span class="text-xs font-normal opacity-80">"${state.lastText}"</span>` : ''}

                    </div>`;

            }



            listenBtn.onclick = () => {

                const audioUrl = mode === 'repeat' ? data.refAudio : data.hintAudio;

                playAudio(audioUrl);

            };



            recordBtn.onclick = async () => {

                if (state.attempts >= 3 || state.passed) return; 

                if (!isRecording) {

                    try {

                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                        mediaRecorder = new MediaRecorder(stream);

                        audioChunks = [];

                        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

                        

                        mediaRecorder.onstop = async () => {

                            stream.getTracks().forEach(track => track.stop());

                            if (recordingTimeout) clearTimeout(recordingTimeout);

                            

                            try {

                                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

                                const reader = new FileReader();

                                reader.readAsDataURL(audioBlob);

                                reader.onloadend = async () => {

                                    const base64 = reader.result.split(',')[1];

                                    const refText = mode === 'repeat' ? data.korean : data.target;

                                    await processSpeech(base64, refText, currentIndex);

                                };

                            } catch (e) {

                                console.error("Error processing audio", e);

                            }

                        };

                        

                        mediaRecorder.start();

                        isRecording = true;

                        

                        recordingTimeout = setTimeout(() => {

                            if (isRecording && mediaRecorder.state === 'recording') {

                                mediaRecorder.stop();

                                isRecording = false;

                                if (document.contains(recordBtn)) {

                                    recordBtn.classList.remove('bg-red-500', 'text-white', 'ring-red-200');

                                    recordBtn.innerHTML = '<i class="ph ph-microphone text-3xl md:text-4xl"></i>';

                                    if(feedbackArea) feedbackArea.innerHTML = '<p class="text-gray-500 text-sm">Analyse...</p>';

                                }

                            }

                        }, 12000);



                        recordBtn.classList.add('bg-red-500', 'text-white', 'ring-red-200');

                        recordBtn.innerHTML = '<i class="ph ph-stop text-3xl md:text-4xl"></i>';

                        feedbackArea.innerHTML = '<p class="text-indigo-600 animate-pulse text-sm">Enregistrement...</p>';

                    } catch (err) {

                        console.error(err);

                        feedbackArea.innerHTML = '<p class="text-red-400 text-sm">Microphone requis.</p>';

                    }

                } else {

                    if (recordingTimeout) clearTimeout(recordingTimeout);

                    mediaRecorder.stop();

                    isRecording = false;

                    recordBtn.classList.remove('bg-red-500', 'text-white', 'ring-red-200');

                    recordBtn.innerHTML = '<i class="ph ph-microphone text-3xl md:text-4xl"></i>';

                    feedbackArea.innerHTML = '<p class="text-gray-500 text-sm">Analyse...</p>';

                }

            };

        }



        function renderListeningQuiz(data) {

            const state = getExerciseState(currentIndex);



            contentArea.innerHTML = `

                <div class="fade-in w-full h-full flex flex-col justify-center items-center">

                    <div class="w-full max-w-2xl flex flex-col gap-8 items-center">

                        <div class="w-full bg-indigo-600 text-white p-5 rounded-2xl shadow-lg text-center">

                             <h2 class="text-lg md:text-xl font-medium leading-snug">${data.question}</h2>

                        </div>

                        

                        <button type="button" id="quiz-audio-btn" class="w-20 h-20 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 flex items-center justify-center shadow-lg transition-transform hover:scale-105">

                            <i class="ph ph-speaker-high text-4xl"></i>

                        </button>



                        <div class="grid grid-cols-2 gap-4 w-full">

                            ${data.options.map((opt, idx) => {

                                let btnClass = "quiz-opt-btn w-full p-4 rounded-xl border-2 text-gray-700 font-bold transition-all flex justify-center items-center bg-white shadow-sm text-sm md:text-base h-20";

                                let isDisabled = "";

                                if (state.passed) {

                                    isDisabled = "disabled";

                                    if (idx === data.answer) {

                                        btnClass += " border-green-500 bg-green-50 text-green-700";

                                    } else {

                                        btnClass += " border-gray-200 opacity-50";

                                    }

                                } else {

                                    btnClass += " border-gray-200 hover:border-indigo-400 hover:bg-indigo-50";

                                }

                                return `

                                <button type="button" onclick="handleQuizAnswer(${idx}, ${data.answer}, this)" class="${btnClass}" ${isDisabled}>

                                    ${opt}

                                </button>

                                `;

                            }).join('')}

                        </div>

                    </div>

                </div>

            `;

            document.getElementById('quiz-audio-btn').onclick = () => {

                if (data.audioUrl) playAudio(data.audioUrl);

                else {

                    const synth = new Tone.Synth().toDestination();

                    synth.triggerAttackRelease("C4", "8n");

                }

            };

        }



        function renderQuiz(data) {

             const state = getExerciseState(currentIndex);



             contentArea.innerHTML = `

                <div class="fade-in w-full h-full relative flex flex-col justify-center items-center">

                    <div class="w-full max-w-2xl flex flex-col gap-6">

                        <div class="w-full bg-indigo-600 text-white p-5 rounded-2xl shadow-lg text-center">

                             <h3 class="text-xs opacity-80 uppercase tracking-wide mb-1">Quiz</h3>

                             <h2 class="text-lg md:text-xl font-medium leading-snug">${data.question}</h2>

                        </div>

                        

                        ${data.context ? `

                            <div class="text-center p-4 bg-gray-50 rounded-xl border border-gray-200">

                                <p class="text-2xl font-bold text-gray-800 mb-2">${data.context}</p>

                                <p class="text-gray-500 italic">${data.meaning}</p>

                            </div>

                        ` : ''}



                        <div class="grid grid-cols-2 gap-3 w-full">

                            ${data.options.map((opt, idx) => {

                                let btnClass = "quiz-opt-btn w-full p-4 rounded-xl border-2 text-gray-700 font-bold transition-all text-center flex justify-center items-center group bg-white shadow-sm text-sm md:text-base";

                                let isDisabled = "";

                                if (state.passed) {

                                    isDisabled = "disabled";

                                    if (idx === data.answer) {

                                        btnClass += " border-green-500 bg-green-50 text-green-700";

                                    } else {

                                        btnClass += " border-gray-200 opacity-50";

                                    }

                                } else {

                                    btnClass += " border-gray-200 hover:border-indigo-400 hover:bg-indigo-50";

                                }

                                return `

                                <button type="button" onclick="handleQuizAnswer(${idx}, ${data.answer}, this)" class="${btnClass}" ${isDisabled}>

                                    <span>${opt}</span>

                                </button>

                                `;

                            }).join('')}

                        </div>

                    </div>

                </div>

            `;

        }



        function renderWritingChallenge(data) {

            const state = getExerciseState(currentIndex);

            let showAudio = (state.attempts >= 2 || state.passed);

            

            // Check if failed max attempts (3 times wrong)

            const isFailed = (state.attempts >= 3 && !state.passed);



            contentArea.innerHTML = `

                <div class="fade-in w-full h-full flex flex-col items-center justify-center gap-6 text-center max-w-2xl mx-auto">

                    <h3 class="text-sm md:text-base font-bold text-indigo-600 uppercase tracking-wider flex-shrink-0">Écrivez en coréen</h3>

                    

                    <div class="bg-white w-full p-8 rounded-3xl shadow-xl border border-gray-100 relative flex flex-col items-center gap-6 flex-shrink-0">

                         <p class="text-xl font-medium text-gray-700">${data.promptFr}</p>

                         

                         ${isFailed ? 

                            `<h2 class="text-2xl md:text-3xl font-bold text-indigo-600">${data.target}</h2>` :

                            `<input type="text" id="write-input" 

                                class="korean-input w-full p-4 text-center text-xl border-2 border-gray-200 rounded-xl transition-all" 

                                placeholder="Tapez ici..." 

                                ${state.passed ? 'disabled' : ''}

                                value="${state.passed ? data.target : ''}">`

                         }



                         <div class="flex gap-4">

                             <button type="button" id="hint-audio-btn" class="${showAudio ? '' : 'hidden'} w-12 h-12 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-100">

                                <i class="ph ph-speaker-high text-2xl"></i>

                             </button>

                             ${!isFailed && !state.passed ? 

                                `<button type="button" id="check-btn" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-md transition-all">

                                    Vérifier

                                </button>` : ''

                             }

                         </div>

                    </div>

                    

                    <div id="feedback-area" class="h-8 font-bold text-sm"></div>

                </div>

            `;



            const input = document.getElementById('write-input');

            const checkBtn = document.getElementById('check-btn');

            const feedback = document.getElementById('feedback-area');

            const audioBtn = document.getElementById('hint-audio-btn');



            if (isFailed) {

                 feedback.innerHTML = `<span class="text-red-500">Terminé. Passons à la suite.</span>`;

            } else if (state.passed) {

                feedback.innerHTML = `<span class="text-green-600">Correct !</span>`;

                if(input) input.classList.add('border-green-500', 'text-green-700');

            }



            if(audioBtn) audioBtn.onclick = () => playAudio(data.hintAudio);



            if(checkBtn) {

                checkBtn.onclick = () => {

                    if (!input) return;

                    const val = input.value.trim().replace(/\.$/, ""); 

                    const targetClean = data.target.replace(/\.$/, "");

                    

                    state.attempts++;



                    if (val === targetClean) {

                        state.passed = true;

                        if(correctSound) correctSound.triggerAttackRelease('E5', '0.1s');

                        feedback.innerHTML = `<span class="text-green-600">Correct !</span>`;

                        input.classList.add('border-green-500', 'text-green-700');

                        checkBtn.remove(); // Remove button on success

                        updateProgress();

                    } else {

                        if(correctSound) correctSound.triggerAttackRelease('G2', '0.2s');

                        

                        if (state.attempts >= 3) {

                            render(); // Re-render to switch to text view

                            updateProgress();

                        } else {

                            feedback.innerHTML = `<span class="text-red-500">Incorrect (${state.attempts}/3)</span>`;

                            render();

                        }

                    }

                };

            }

        }



        function renderOutro(data) {

             navArea.classList.add('hidden');

             contentArea.innerHTML = `

                <div class="fade-in w-full h-full flex flex-col items-center justify-center gap-6 text-center max-w-2xl mx-auto">

                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Terminé !</h2>

                    <div class="w-full bg-indigo-600 text-white p-6 rounded-2xl shadow-lg text-base md:text-lg leading-relaxed">

                        ${data.text}

                    </div>

                </div>

            `;

            if (completionSynth) setTimeout(() => completionSynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "4n"), 500);

            window.parent.postMessage({ type: 'lesson_complete' }, '*');

        }



        // --- Shared Logic ---



        window.handleQuizAnswer = (selectedIdx, correctIdx, btnElement) => {

            const allBtns = document.querySelectorAll('.quiz-opt-btn');

            const state = getExerciseState(currentIndex);



            if (selectedIdx === correctIdx) {

                // Correct

                state.passed = true;

                btnElement.classList.remove('border-gray-200', 'hover:border-indigo-400', 'hover:bg-indigo-50');

                btnElement.classList.add('border-green-500', 'bg-green-50', 'text-green-700');

                allBtns.forEach(b => {

                    b.disabled = true;

                    if(b !== btnElement) b.classList.add('opacity-50');

                });

                if(correctSound) correctSound.triggerAttackRelease('E5', '0.1s');

                nextBtn.disabled = false;

            } else {

                // Wrong

                btnElement.classList.remove('border-gray-200');

                btnElement.classList.add('border-red-500', 'bg-red-50', 'text-red-700');

                if(correctSound) correctSound.triggerAttackRelease('G2', '0.2s');

            }

        };



        async function processSpeech(audioBase64, referenceText, pageIndex) {

            const state = getExerciseState(pageIndex);

            state.attempts++;



            try {

                // Correct payload with referenceText as required by backend

                const payload = { 

                    audioBase64: audioBase64, 

                    languageCode: "Kor", 

                    referenceText: referenceText 

                };



                const res = await fetch(CLOVA_API_FUNCTION_URL, {

                    method: 'POST', 

                    headers: { 'Content-Type': 'application/json' },

                    body: JSON.stringify(payload)

                });



                if (!res.ok) throw new Error("API Error: " + res.status); 

                const result = await res.json();

                

                // Use 'text' from response (utterance might be in raw but text is standard)

                const recognizedText = result.text || ""; 

                const score = Number(result.assessment?.pronunciation_score || 0);

                

                state.lastScore = score;

                state.lastText = recognizedText; 



                // Strict validation: Score AND text match (ignoring spaces/punctuation)

                const cleanRef = referenceText.replace(/[\s.,?!]/g, "");

                const cleanRec = recognizedText.replace(/[\s.,?!]/g, "");



                if (score >= 80 && cleanRec === cleanRef) {

                    if(correctSound) correctSound.triggerAttackRelease('C5', '0.2s');

                    state.passed = true;

                } else {

                     if(correctSound) correctSound.triggerAttackRelease('G2', '0.2s');

                }

            } catch (e) {

                console.error("Speech Eval Failed:", e);

                state.lastScore = 0; 

                state.lastText = "Erreur de connexion";

                if(correctSound) correctSound.triggerAttackRelease('G2', '0.2s');

            }

            

            render(); 

            updateProgress();

        }



        // --- Render Engine ---

        function render() {

            stopAudio();

            updateProgress();

            const data = lessonData[currentIndex];

            contentArea.innerHTML = ''; 



            switch(data.type) {

                case 'cover': renderCover(data); break;

                case 'intro': renderIntro(data); break;

                case 'learn': renderLearn(data); break;

                case 'repeat': renderRepeat(data); break;

                case 'listening_quiz': renderListeningQuiz(data); break;

                case 'speaking_challenge': renderSpeakingChallenge(data); break;

                case 'quiz': renderQuiz(data); break;

                case 'writing_challenge': renderWritingChallenge(data); break;

                case 'outro': renderOutro(data); break;

                default: console.error("Unknown type");

            }

        }



        async function nextPage() {

            await initAudio(); 

            playPageSound();

            if (currentIndex < lessonData.length - 1) {

                currentIndex++;

                render();

            }

        }



        function prevPage() {

            playPageSound();

            if (currentIndex > 0) {

                currentIndex--;

                render();

            }

        }



        nextBtn.addEventListener('click', nextPage);

        prevBtn.addEventListener('click', prevPage);



        render();

    </script>

</body>

</html>
