<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L'activité (3) Présenter quelqu’un</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for Audio Synth -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans', 'Noto Sans KR', sans-serif;
            overflow: hidden;
            background-color: white;
            touch-action: manipulation;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
        }

        #game-container {
            position: relative;
            background: white;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-hover:active {
            transform: scale(0.95);
        }

        .result-box {
            @apply border rounded-xl p-3 mb-2 text-sm;
        }
    </style>
</head>
<body class="bg-white">

    <div id="game-container">
        <!-- Progress Bar -->
        <div class="absolute top-0 left-0 w-full h-1.5 bg-gray-100 z-50">
            <div id="progress-bar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
        </div>

        <!-- Main Content Area -->
        <div id="content-area" class="flex-1 w-full relative overflow-hidden flex flex-col items-center justify-center p-4">
            <!-- Dynamic Content -->
        </div>

        <!-- Navigation Bar -->
        <div id="nav-area" class="w-full h-20 px-6 md:px-12 flex justify-between items-center bg-white border-t border-gray-100 z-40 shrink-0">
            <!-- Prev button hidden on cover, logic handled in updateProgress -->
            <button type="button" id="prev-btn" class="btn-hover bg-gray-100 text-gray-600 w-12 h-12 rounded-full flex items-center justify-center hover:bg-gray-200 transition-all disabled:opacity-30 disabled:cursor-not-allowed">
                <i class="ph ph-arrow-left text-xl font-bold"></i>
            </button>
            
            <button type="button" id="next-btn" class="btn-hover bg-indigo-600 text-white px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-indigo-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                Continuer <i class="ph ph-arrow-right font-bold"></i>
            </button>
        </div>
    </div>

    <script>
        const GEMINI_FUNCTION_URL = "https://coreeno.base44.app/api/apps/69021ec9e4512a451556d88d/functions/Geminichat";

        // --- Data & State Management ---
        const assessmentResults = {}; 

        const lessonData = [
            {
                type: 'cover',
                chapter: 'L’activité (3)',
                title: 'Présenter quelqu’un',
                btnText: 'Commencer'
            },
            {
                type: 'challenge',
                image: "https://res.cloudinary.com/de76i94ia/image/upload/v1771435038/imageA-text_hutocr.png",
                instruction: "Présentez vous-même la personne en coréen.",
                systemInstruction: `
Prénom: Jiyeon / Métier: Médecin / Nationalité: Américaine - 이 인물을 한국어로 설명하는 과제에 대한 유저 응답을 평가합니다.
응답 세 부분으로 구성되며, 각 부분을 시작할 때 [Transcription], [Score], [Explication] 이라는 태그로 시작합니다. 세 가지 외 다른 항목은 절대 출력하지 않습니다.
[Transcription] 들은 내용을 그대로 한국어로 전사.
[Score] 이름, 직업, 국적을 모두 오류없이 발화하면 20점 만점입니다. 주어를 생략하거나 기댓값과 약간 다르다고 해도 문법 오류가 없이 자연스러운 한국어로 말하면 18점 이상에 해당합니다. 문법 오류 (조사 생략, ‘씨’ 생략, 이에요/입니다/이야 간 문체 혼용) 또는 어색한 표현마다 감점합니다. 부족한 부분이 있지만 이해에 문제가 없는 경우 14점 이상, 세가지 중 두 가지 이상을 제대로 말하지 못한 경우 10점 미만, 발화 내용을 이해하기 어려운 경우 5점 미만에 해당합니다.
[Explication] 감점 요인이 된 오류를 프랑스어로 설명합니다. 설명은 간단하고 직관적으로 작성합니다. 한국어를 인용할 때는 한글로만 작성하고 (씨 - Ssi) 처럼 로마자로 표기하거나 프랑스어로 해석하지 않습니다. 별도의 Correction 을 작성하거나 Explication 의 내용을 여러 번 반복하지 않습니다.
                `
            },
            {
                type: 'feedback',
                refIndex: 1, 
                exampleKr: "이 사람은 지연 씨예요. 지연 씨는 의사예요. 지연 씨는 미국 사람이에요.",
                exampleFr: "Cette personne est Jiyeon. Jiyeon est médecin. Jiyeon est américaine."
            },
            {
                type: 'challenge',
                image: "https://res.cloudinary.com/de76i94ia/image/upload/v1771435039/imageB-text_didcme.png",
                instruction: "Présentez vous-même la personne en coréen.",
                systemInstruction: `
이름: 시몬 / 관계: 오빠 / 직업: 회사원 - 이 인물을 한국어로 설명하는 과제에 대한 유저 응답을 평가합니다.
응답 세 부분으로 구성되며, 각 부분을 시작할 때 [Transcription], [Score], [Explication] 이라는 태그로 시작합니다. 세 가지 외 다른 항목은 절대 출력하지 않습니다.
[Transcription] 들은 내용을 그대로 한국어로 전사.
[Score] 이름, 관계, 직업을 모두 오류없이 발화하면 20점 만점입니다. 주어를 생략하거나 기댓값과 약간 다르다고 해도 문법 오류가 없이 자연스러운 한국어로 말하면 18점 이상에 해당합니다. 문법 오류 (조사 생략, 이에요/입니다/이야 간 문체 혼용) 또는 어색한 표현마다 감점합니다. 부족한 부분이 있지만 이해에 문제가 없는 경우 14점 이상, 세가지 중 두 가지 이상을 제대로 말하지 못한 경우 10점 미만, 발화 내용을 이해하기 어려운 경우 5점 미만에 해당합니다.
[Explication] 감점 요인이 된 오류를 프랑스어로 설명합니다. 설명은 간단하고 직관적으로 작성합니다. 한국어를 인용할 때는 한글로만 작성하고 (씨 - Ssi) 처럼 로마자로 표기하거나 프랑스어로 해석하지 않습니다. 별도의 Correction을 작성하거나 Explication 의 내용을 여러 번 반복하지 않습니다.
                `
            },
            {
                type: 'feedback',
                refIndex: 3,
                exampleKr: "이 사람은 시몬이에요. 시몬은 제 오빠예요. 회사원이에요.",
                exampleFr: "Cette personne est Simon. Simon est mon grand frère. Il est employé."
            },
            {
                type: 'outro',
                text: "Vous avez terminé le programme <Parler des personnes et des objets> !\nRévisez ce que vous avez appris et essayez de l'appliquer dans la vie réelle.\nAlors, on se retrouve dans un prochain programme, 안녕히 가세요!",
                audio: "https://res.cloudinary.com/de76i94ia/video/upload/v1771435806/L12_audio_kcmzhc.mp3"
            }
        ];

        // --- State ---
        let currentIndex = 0;
        let isRecording = false;
        let isProcessing = false;
        let mediaRecorder;
        let audioChunks = [];
        let recordingTimeout;
        
        let audioPlayer = new Audio();
        let autoPlayTimeout = null;

        // Tone.js
        let toneStarted = false;
        let completionSynth = null;
        let pageTurnSynth = null;

        async function initAudio() {
            if (toneStarted) return;
            await Tone.start();
            completionSynth = new Tone.PolySynth().toDestination();
            pageTurnSynth = new Tone.MembraneSynth({ envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
            toneStarted = true;
        }

        function playPageSound() {
            if (pageTurnSynth && toneStarted) pageTurnSynth.triggerAttackRelease("C2", "32n");
        }

        // --- DOM ---
        const contentArea = document.getElementById('content-area');
        const progressBar = document.getElementById('progress-bar');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const navArea = document.getElementById('nav-area');

        // --- Core Functions ---
        function updateProgress() {
            const progress = ((currentIndex) / (lessonData.length - 1)) * 100;
            progressBar.style.width = `${progress}%`;
            
            if (currentIndex === 0) prevBtn.classList.add('invisible');
            else {
                prevBtn.classList.remove('invisible');
                prevBtn.disabled = false;
            }
            
            const currentData = lessonData[currentIndex];
            let canProceed = true;

            // Lock 'challenge' slide until assessment is done
            if (currentData.type === 'challenge') {
                if (assessmentResults[currentIndex]) canProceed = true;
                else canProceed = false;
            }

            nextBtn.disabled = !canProceed;

            if (currentIndex === lessonData.length - 1) {
                nextBtn.innerHTML = `Terminer <i class="ph ph-check text-xl"></i>`;
            } else {
                nextBtn.innerHTML = `Continuer <i class="ph ph-arrow-right font-bold"></i>`;
                navArea.classList.remove('hidden');
            }
        }

        function stopAudioPlayer() {
            if(audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }
            if(autoPlayTimeout) clearTimeout(autoPlayTimeout);
        }

        function playAudio(url) {
            stopAudioPlayer();
            if(!url) return;
            autoPlayTimeout = setTimeout(() => {
                audioPlayer.src = url;
                audioPlayer.play().catch(e => console.log("Audio play error", e));
            }, 500);
        }

        // --- Render Functions ---

        function renderCover(data) {
            contentArea.innerHTML = `
                <div class="fade-in w-full h-full flex flex-col items-center justify-center gap-10 text-center max-w-3xl mx-auto">
                    <div class="bg-indigo-100 p-8 rounded-full shadow-md shrink-0">
                        <i class="ph ph-microphone-stage text-6xl text-indigo-600"></i>
                    </div>
                    <div class="space-y-6 shrink-0">
                        <h1 class="text-lg font-bold text-indigo-600 uppercase tracking-widest">${data.chapter}</h1>
                        <h2 class="text-2xl font-bold text-gray-800 leading-tight">${data.title}</h2>
                    </div>
                </div>
            `;
        }

        function renderChallenge(data) {
            const hasResult = assessmentResults[currentIndex];

            // Modified: Removed shadow-xl from the inner bg-white div
            contentArea.innerHTML = `
                <div class="fade-in w-full h-full flex flex-col items-center max-w-2xl mx-auto py-2">
                    <div class="w-full flex justify-center pb-2 shrink-0">
                        <h3 class="text-xs text-indigo-600 uppercase tracking-wider text-center font-bold">
                            ${data.instruction}
                        </h3>
                    </div>
                    
                    <div class="bg-white w-full p-6 rounded-3xl border border-gray-100 relative flex flex-col items-center gap-6 shrink-1 min-h-0 z-10 flex-1 overflow-hidden">
                        
                        <div class="flex-1 w-full flex items-center justify-center min-h-0 overflow-hidden rounded-xl">
                            <img src="${data.image}" class="max-h-full max-w-full object-contain" alt="Challenge Image">
                        </div>
                        
                        <div class="w-full flex flex-col items-center shrink-0 pt-2 bg-white z-20 gap-4">
                            
                            <div class="text-center space-y-2">
                                <p class="text-sm text-gray-500">Appuyez pour enregistrer (Max 15s)</p>
                            </div>

                            <button id="record-btn" class="w-20 h-20 rounded-full ${hasResult ? 'bg-green-500 text-white' : 'bg-white text-indigo-600 border-4 border-gray-100'} flex items-center justify-center transition-all shadow-lg hover:scale-105" ${hasResult ? 'disabled' : ''}>
                                ${hasResult ? '<i class="ph ph-check text-3xl"></i>' : '<i class="ph ph-microphone text-3xl"></i>'}
                            </button>

                            <div id="status-text" class="h-6 text-sm font-bold text-indigo-600">
                                ${hasResult ? 'Évaluation terminée.' : ''}
                            </div>

                        </div>
                    </div>
                </div>
            `;

            const recordBtn = document.getElementById('record-btn');
            const statusText = document.getElementById('status-text');

            if (!hasResult) {
                recordBtn.onclick = () => startRecording(data.systemInstruction, recordBtn, statusText);
            }
        }

        function renderFeedback(data) {
            const result = assessmentResults[data.refIndex] || { transcription: "-", score: "0", explication: "No data" };

            // Modified: Removed flex-1 from the AI evaluation box to prevent vertical stretching and ensure perfect centering
            contentArea.innerHTML = `
                <div class="fade-in w-full h-full flex flex-col items-center justify-center max-w-3xl mx-auto py-2 gap-4">
                    
                    <div class="w-full bg-white p-5 rounded-2xl shadow-md border border-gray-200 shrink-0">
                        <h3 class="text-sm font-bold text-gray-500 uppercase mb-2">Exemple de réponse</h3>
                        <p class="text-lg font-bold text-indigo-900 mb-1">${data.exampleKr}</p>
                        <p class="text-sm text-gray-600 italic">${data.exampleFr}</p>
                    </div>

                    <div class="w-full bg-indigo-50 p-5 rounded-2xl shadow-inner border border-indigo-100 overflow-y-auto shrink min-h-0">
                        <h3 class="text-sm font-bold text-indigo-600 uppercase mb-4 flex items-center gap-2">
                            <i class="ph ph-robot"></i> Évaluation de l'IA
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="bg-white p-3 rounded-xl shadow-sm">
                                <span class="text-xs font-bold text-gray-400 uppercase block mb-1">Transcription</span>
                                <p class="text-gray-800 text-base">"${result.transcription}"</p>
                            </div>

                            <div class="bg-white p-3 rounded-xl shadow-sm flex items-center justify-between">
                                <span class="text-xs font-bold text-gray-400 uppercase">Score</span>
                                <span class="text-xl font-bold text-indigo-600">${result.score} / 20</span>
                            </div>

                            <div class="bg-white p-3 rounded-xl shadow-sm">
                                <span class="text-xs font-bold text-gray-400 uppercase block mb-1">Explication</span>
                                <p class="text-gray-700 text-sm leading-relaxed">${result.explication}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderOutro(data) {
            navArea.classList.add('hidden');
            contentArea.innerHTML = `
                <div class="fade-in w-full h-full flex flex-col items-center justify-center gap-6 text-center max-w-2xl mx-auto">
                    <div class="w-[15vh] h-[15vh] bg-green-100 rounded-full flex items-center justify-center mb-4 text-green-600 animate-bounce shadow-lg">
                         <i class="ph ph-confetti icon-fluid-lg text-6xl"></i>
                    </div>
                    <div class="w-full bg-indigo-600 text-white p-8 rounded-2xl shadow-lg text-lg leading-relaxed whitespace-pre-line">
                        ${data.text}
                    </div>
                </div>
            `;
            if (data.audio) playAudio(data.audio);
            
            if (completionSynth) setTimeout(() => completionSynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "4n"), 500);
            window.parent.postMessage({ type: 'lesson_complete' }, '*');
        }

        // --- Recording & Gemini Logic ---

        async function startRecording(systemInstruction, btn, statusEl) {
            if (isRecording || isProcessing) return;

            try {
                await initAudio();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

                mediaRecorder.onstop = async () => {
                    stream.getTracks().forEach(track => track.stop());
                    
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = async () => {
                        const base64Audio = reader.result.split(',')[1];
                        await sendToGemini(base64Audio, systemInstruction, statusEl);
                    };
                };

                mediaRecorder.start();
                isRecording = true;

                // UI Update: Recording
                btn.classList.remove('bg-white', 'border-gray-100', 'text-indigo-600');
                btn.classList.add('bg-red-500', 'text-white', 'animate-pulse', 'border-red-500');
                btn.innerHTML = `<i class="ph ph-stop text-3xl"></i>`;
                statusEl.innerText = "Enregistrement (15s max)...";

                // Auto stop after 15s
                recordingTimeout = setTimeout(() => {
                    if (isRecording) stopRecording(btn, statusEl);
                }, 15000);

                // Click to stop manually
                btn.onclick = () => stopRecording(btn, statusEl);

            } catch (e) {
                console.error("Mic Error:", e);
                statusEl.innerText = "Erreur microphone";
            }
        }

        function stopRecording(btn, statusEl) {
            if (!isRecording) return;
            if (recordingTimeout) clearTimeout(recordingTimeout);
            
            mediaRecorder.stop();
            isRecording = false;
            
            // UI Update to Processing
            btn.onclick = null; // Disable click
            btn.disabled = true;
            btn.classList.remove('bg-red-500', 'text-white', 'animate-pulse', 'border-red-500');
            btn.classList.add('bg-gray-200', 'text-gray-400');
            btn.innerHTML = `<i class="ph ph-spinner animate-spin text-3xl"></i>`;
            
            statusEl.innerText = "Analyse en cours...";
            isProcessing = true;
        }

        async function sendToGemini(base64Audio, systemInstruction, statusEl) {
            try {
                const payload = {
                    model: "gemini-2.5-flash",
                    systemInstruction: systemInstruction,
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: "Audio input for evaluation" },
                                { 
                                    inline_data: { 
                                        mime_type: "audio/webm", 
                                        data: base64Audio 
                                    } 
                                }
                            ]
                        }
                    ]
                };

                const response = await fetch(GEMINI_FUNCTION_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error("Gemini API Error: " + response.status);
                }
                
                const data = await response.json();
                const rawText = data.text || ""; 
                
                const result = parseGeminiOutput(rawText);
                assessmentResults[currentIndex] = result;
                
                isProcessing = false;
                statusEl.innerText = "Évaluation terminée.";
                const btn = document.getElementById('record-btn');
                if(btn) {
                    btn.innerHTML = `<i class="ph ph-check text-3xl"></i>`;
                    btn.classList.remove('bg-gray-200', 'text-gray-400');
                    btn.classList.add('bg-green-500', 'text-white');
                }
                
                if (completionSynth) completionSynth.triggerAttackRelease("C5", "0.2s");
                updateProgress();

            } catch (e) {
                console.error(e);
                isProcessing = false;
                statusEl.innerText = "Erreur technique";
                const btn = document.getElementById('record-btn');
                if(btn) {
                    btn.disabled = false;
                    // Reset to initial style
                    btn.innerHTML = `<i class="ph ph-microphone text-3xl"></i>`;
                    btn.classList.remove('bg-gray-200', 'text-gray-400');
                    btn.classList.add('bg-white', 'text-indigo-600', 'border-4', 'border-gray-100');
                    // Re-attach listener for retry
                    btn.onclick = () => startRecording(systemInstruction, btn, statusEl); 
                }
            }
        }

        function parseGeminiOutput(text) {
            const extract = (tag) => {
                const regex = new RegExp(`\\[${tag}\\]\\s*(.*?)(?=\\[|$)`, 's');
                const match = text.match(regex);
                return match ? match[1].trim() : "-";
            };

            let score = extract("Score");
            const scoreMatch = score.match(/(\d+)/);
            if (scoreMatch) {
                score = scoreMatch[0];
            }

            return {
                transcription: extract("Transcription"),
                score: score,
                explication: extract("Explication")
            };
        }

        // --- Render Engine ---

        function render() {
            stopAudioPlayer();
            updateProgress();
            const data = lessonData[currentIndex];
            contentArea.innerHTML = ''; 

            switch(data.type) {
                case 'cover': renderCover(data); break;
                case 'challenge': renderChallenge(data); break;
                case 'feedback': renderFeedback(data); break;
                case 'outro': renderOutro(data); break;
                default: console.error("Unknown type");
            }
        }

        async function nextPage() {
            await initAudio(); 
            playPageSound();
            if (currentIndex < lessonData.length - 1) {
                currentIndex++;
                render();
            }
        }

        function prevPage() {
            playPageSound();
            if (currentIndex > 0) {
                currentIndex--;
                render();
            }
        }

        nextBtn.addEventListener('click', nextPage);
        prevBtn.addEventListener('click', prevPage);

        render();
    </script>
</body>
</html>
